<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BingoChain - Sorteo NFT</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; }
        .card { box-shadow: 0 10px 30px rgba(0,0,0,0.2); border: none; }
        .wallet-connected { background: #d4edda; border: 1px solid #c3e6cb; }
        .wallet-disconnected { background: #f8d7da; border: 1px solid #f5c6cb; }
        .wallet-detecting { background: #fff3cd; border: 1px solid #ffeaa7; }
        .number-grid { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; margin: 20px 0; }
        .number-btn { 
            aspect-ratio: 1; padding: 8px; border: 2px solid #ddd; background: white; 
            border-radius: 8px; cursor: pointer; transition: all 0.3s;
        }
        .number-btn:hover { background: #e9ecef; border-color: #007bff; }
        .number-btn.selected { background: #007bff; color: white; border-color: #007bff; }
        .status-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .status-connected { background-color: #28a745; }
        .status-disconnected { background-color: #dc3545; }
        .status-detecting { background-color: #ffc107; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-dice me-2"></i>BingoChain</a>
            <div class="d-flex align-items-center">
                <span id="connectionStatus" class="text-light me-3">
                    <span class="status-indicator status-detecting"></span>Detectando...
                </span>
                <button id="walletBtn" class="btn btn-outline-light" onclick="handleWalletAction()">
                    <i class="fas fa-wallet"></i> <span id="walletBtnText">Detectando MetaMask...</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Status Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-info-circle"></i> Estado del Sistema</h5>
                <div id="systemStatus" class="wallet-detecting p-3 rounded">
                    <i class="fas fa-spinner fa-spin"></i> Inicializando detección de MetaMask...
                </div>
                <div id="debugInfo" class="mt-3" style="display: none;">
                    <h6>Información de Debug:</h6>
                    <div id="debugDetails" class="bg-light p-2 rounded small font-monospace"></div>
                </div>
                <button class="btn btn-sm btn-secondary mt-2" onclick="toggleDebug()">
                    <i class="fas fa-bug"></i> Toggle Debug
                </button>
            </div>
        </div>

        <!-- Lottery Card -->
        <div class="card mb-4">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-trophy"></i> Sorteo Semanal #1</h5>
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>Estado:</strong> <span class="badge bg-success">Abierto</span></p>
                        <p><strong>Premio:</strong> 10 ETH</p>
                        <p><strong>Precio por boleto:</strong> 0.01 ETH</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Cierre de ventas:</strong> Lunes 12:00 PM</p>
                        <p><strong>Números sorteados:</strong> 0/6</p>
                        <p><strong>Participantes:</strong> 0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchase Card -->
        <div class="card" id="purchaseCard">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-shopping-cart"></i> Comprar Boleto NFT</h5>
                <p class="text-muted">Selecciona 6 números del 01 al 100:</p>
                
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <span>Números seleccionados: <strong id="selectedCount">0</strong>/6</span>
                    <div>
                        <button class="btn btn-sm btn-outline-primary" onclick="quickPick()">
                            <i class="fas fa-random"></i> Selección Rápida
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="clearSelection()">
                            <i class="fas fa-eraser"></i> Limpiar
                        </button>
                    </div>
                </div>

                <div id="numberGrid" class="number-grid"></div>

                <div class="text-center mt-4">
                    <button id="purchaseBtn" class="btn btn-primary btn-lg" onclick="purchaseTicket()" disabled>
                        <i class="fas fa-shopping-cart"></i> Comprar Boleto NFT (0.01 ETH)
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // === VARIABLES GLOBALES ===
        let walletState = {
            detected: false,
            connected: false,
            account: null,
            provider: null,
            web3: null,
            chainId: null
        };

        let selectedNumbers = new Set();
        const MAX_NUMBERS = 6;
        const GANACHE_CHAIN_ID = '0x539'; // 1337 in hex

        // === DETECCIÓN DE METAMASK COMPLETAMENTE NUEVA ===
        class MetaMaskDetector {
            constructor() {
                this.detectionMethods = [];
                this.maxWaitTime = 10000; // 10 segundos
                this.checkInterval = 100; // cada 100ms
            }

            // Método 1: window.ethereum estándar
            checkWindowEthereum() {
                return new Promise((resolve) => {
                    if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                        this.log('✅ Método 1: window.ethereum detectado');
                        resolve(window.ethereum);
                    } else {
                        this.log('❌ Método 1: window.ethereum no disponible');
                        resolve(null);
                    }
                });
            }

            // Método 2: Buscar en providers array
            checkEthereumProviders() {
                return new Promise((resolve) => {
                    if (window.ethereum && window.ethereum.providers && Array.isArray(window.ethereum.providers)) {
                        const metamaskProvider = window.ethereum.providers.find(p => p.isMetaMask);
                        if (metamaskProvider) {
                            this.log('✅ Método 2: MetaMask encontrado en providers array');
                            resolve(metamaskProvider);
                        } else {
                            this.log('❌ Método 2: MetaMask no encontrado en providers');
                            resolve(null);
                        }
                    } else {
                        this.log('❌ Método 2: No hay providers array');
                        resolve(null);
                    }
                });
            }

            // Método 3: Web3 legacy
            checkLegacyWeb3() {
                return new Promise((resolve) => {
                    if (typeof window.web3 !== 'undefined' && window.web3.currentProvider) {
                        if (window.web3.currentProvider.isMetaMask) {
                            this.log('✅ Método 3: Legacy web3 con MetaMask detectado');
                            resolve(window.web3.currentProvider);
                        } else {
                            this.log('❌ Método 3: Legacy web3 sin MetaMask');
                            resolve(null);
                        }
                    } else {
                        this.log('❌ Método 3: No hay legacy web3');
                        resolve(null);
                    }
                });
            }

            // Método 4: Polling con timeout
            pollForMetaMask() {
                return new Promise((resolve) => {
                    let attempts = 0;
                    const maxAttempts = this.maxWaitTime / this.checkInterval;

                    const pollInterval = setInterval(() => {
                        attempts++;
                        
                        if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                            this.log(`✅ Método 4: MetaMask detectado después de ${attempts} intentos`);
                            clearInterval(pollInterval);
                            resolve(window.ethereum);
                            return;
                        }

                        if (attempts >= maxAttempts) {
                            this.log('❌ Método 4: Timeout alcanzado sin detectar MetaMask');
                            clearInterval(pollInterval);
                            resolve(null);
                        }
                    }, this.checkInterval);
                });
            }

            // Método 5: Event listener para ethereum
            waitForEthereumEvent() {
                return new Promise((resolve) => {
                    const timeout = setTimeout(() => {
                        this.log('❌ Método 5: Timeout esperando evento ethereum');
                        resolve(null);
                    }, 3000);

                    const checkEthereum = () => {
                        if (typeof window.ethereum !== 'undefined' && window.ethereum.isMetaMask) {
                            this.log('✅ Método 5: MetaMask detectado por evento');
                            clearTimeout(timeout);
                            resolve(window.ethereum);
                        }
                    };

                    // Check immediately
                    checkEthereum();

                    // Listen for ethereum object injection
                    window.addEventListener('ethereum#initialized', checkEthereum, { once: true });
                    
                    // Also try DOMContentLoaded
                    if (document.readyState === 'loading') {
                        document.addEventListener('DOMContentLoaded', checkEthereum, { once: true });
                    }
                });
            }

            log(message) {
                console.log(`[MetaMaskDetector] ${message}`);
                this.updateDebugInfo(message);
            }

            updateDebugInfo(message) {
                const debugDetails = document.getElementById('debugDetails');
                if (debugDetails) {
                    debugDetails.innerHTML += message + '\n';
                    debugDetails.scrollTop = debugDetails.scrollHeight;
                }
            }

            // Ejecutar todos los métodos de detección
            async detectMetaMask() {
                this.log('🔍 Iniciando detección de MetaMask...');
                
                // Limpiar debug info
                const debugDetails = document.getElementById('debugDetails');
                if (debugDetails) debugDetails.innerHTML = '';

                // Información del navegador
                this.log(`Navegador: ${navigator.userAgent}`);
                this.log(`URL: ${window.location.href}`);
                this.log(`Protocolo: ${window.location.protocol}`);

                // Ejecutar todos los métodos en paralelo
                const methods = [
                    this.checkWindowEthereum(),
                    this.checkEthereumProviders(),
                    this.checkLegacyWeb3(),
                    this.pollForMetaMask(),
                    this.waitForEthereumEvent()
                ];

                try {
                    const results = await Promise.allSettled(methods);
                    
                    // Buscar el primer resultado exitoso
                    for (let i = 0; i < results.length; i++) {
                        if (results[i].status === 'fulfilled' && results[i].value) {
                            this.log(`🎉 MetaMask detectado exitosamente con método ${i + 1}`);
                            return results[i].value;
                        }
                    }

                    this.log('❌ Ningún método de detección fue exitoso');
                    return null;

                } catch (error) {
                    this.log(`❌ Error durante la detección: ${error.message}`);
                    return null;
                }
            }
        }

        // === MANAGER DE WALLET ===
        class WalletManager {
            constructor() {
                this.detector = new MetaMaskDetector();
            }

            async initialize() {
                updateSystemStatus('Detectando MetaMask...', 'detecting');
                
                const provider = await this.detector.detectMetaMask();
                
                if (provider) {
                    walletState.detected = true;
                    walletState.provider = provider;
                    
                    updateSystemStatus('MetaMask detectado. Listo para conectar.', 'disconnected');
                    updateWalletButton('Conectar MetaMask', true);
                    
                    // Setup event listeners
                    this.setupEventListeners();
                    
                    // Check if already connected
                    await this.checkExistingConnection();
                    
                } else {
                    walletState.detected = false;
                    updateSystemStatus('MetaMask no detectado. Instala MetaMask para continuar.', 'disconnected');
                    updateWalletButton('MetaMask No Detectado', false);
                    this.showInstallationInstructions();
                }
            }

            async checkExistingConnection() {
                try {
                    const accounts = await walletState.provider.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        console.log('Conexión existente encontrada');
                        await this.handleAccountsChanged(accounts);
                    }
                } catch (error) {
                    console.log('No hay conexión existente:', error.message);
                }
            }

            setupEventListeners() {
                if (!walletState.provider) return;

                walletState.provider.on('accountsChanged', this.handleAccountsChanged.bind(this));
                walletState.provider.on('chainChanged', this.handleChainChanged.bind(this));
                walletState.provider.on('disconnect', this.handleDisconnect.bind(this));
            }

            async handleAccountsChanged(accounts) {
                if (accounts.length === 0) {
                    // User disconnected
                    walletState.connected = false;
                    walletState.account = null;
                    updateSystemStatus('MetaMask desconectado', 'disconnected');
                    updateWalletButton('Conectar MetaMask', true);
                } else {
                    // User connected or switched accounts
                    walletState.connected = true;
                    walletState.account = accounts[0];
                    
                    // Check chain
                    const chainId = await walletState.provider.request({ method: 'eth_chainId' });
                    walletState.chainId = chainId;
                    
                    if (chainId === GANACHE_CHAIN_ID) {
                        updateSystemStatus(`Conectado: ${this.formatAddress(accounts[0])} (Red Ganache)`, 'connected');
                        updateWalletButton('Desconectar', true);
                        enablePurchasing(true);
                    } else {
                        updateSystemStatus(`Conectado pero en red incorrecta. Cambia a Ganache (Chain ID: 1337)`, 'disconnected');
                        updateWalletButton('Cambiar Red', true);
                        enablePurchasing(false);
                    }
                }
            }

            async handleChainChanged(chainId) {
                walletState.chainId = chainId;
                if (walletState.connected) {
                    if (chainId === GANACHE_CHAIN_ID) {
                        updateSystemStatus(`Conectado: ${this.formatAddress(walletState.account)} (Red Ganache)`, 'connected');
                        enablePurchasing(true);
                    } else {
                        updateSystemStatus('Red incorrecta. Cambia a Ganache (Chain ID: 1337)', 'disconnected');
                        enablePurchasing(false);
                    }
                }
            }

            handleDisconnect() {
                walletState.connected = false;
                walletState.account = null;
                updateSystemStatus('MetaMask desconectado', 'disconnected');
                updateWalletButton('Conectar MetaMask', true);
                enablePurchasing(false);
            }

            async connect() {
                if (!walletState.detected) {
                    alert('MetaMask no está instalado o detectado');
                    return false;
                }

                try {
                    updateSystemStatus('Conectando a MetaMask...', 'detecting');
                    
                    const accounts = await walletState.provider.request({
                        method: 'eth_requestAccounts'
                    });

                    if (accounts.length > 0) {
                        await this.handleAccountsChanged(accounts);
                        return true;
                    } else {
                        updateSystemStatus('No se encontraron cuentas en MetaMask', 'disconnected');
                        return false;
                    }
                } catch (error) {
                    console.error('Error conectando:', error);
                    updateSystemStatus(`Error: ${error.message}`, 'disconnected');
                    return false;
                }
            }

            async addGanacheNetwork() {
                try {
                    await walletState.provider.request({
                        method: 'wallet_addEthereumChain',
                        params: [{
                            chainId: GANACHE_CHAIN_ID,
                            chainName: 'Ganache Local',
                            rpcUrls: ['http://127.0.0.1:8545'],
                            nativeCurrency: {
                                name: 'Ethereum',
                                symbol: 'ETH',
                                decimals: 18
                            }
                        }]
                    });
                    return true;
                } catch (error) {
                    console.error('Error agregando red:', error);
                    return false;
                }
            }

            formatAddress(address) {
                return `${address.substring(0, 6)}...${address.substring(38)}`;
            }

            showInstallationInstructions() {
                const instructions = `
Para usar BingoChain necesitas MetaMask:

1. Ve a https://metamask.io
2. Instala la extensión en tu navegador
3. Crea una wallet o importa una existente
4. Recarga esta página
5. Conecta tu wallet

¿Necesitas ayuda con la configuración?
                `;
                
                setTimeout(() => {
                    if (confirm(instructions + '\n\n¿Quieres que te abra la página de MetaMask?')) {
                        window.open('https://metamask.io', '_blank');
                    }
                }, 2000);
            }
        }

        // === FUNCIONES DE UI ===
        function updateSystemStatus(message, type) {
            const statusElement = document.getElementById('systemStatus');
            const connectionStatus = document.getElementById('connectionStatus');
            
            statusElement.className = `wallet-${type} p-3 rounded`;
            
            const icons = {
                connected: '<i class="fas fa-check-circle text-success"></i>',
                disconnected: '<i class="fas fa-times-circle text-danger"></i>',
                detecting: '<i class="fas fa-spinner fa-spin text-warning"></i>'
            };
            
            statusElement.innerHTML = `${icons[type]} ${message}`;
            
            // Update connection indicator
            const indicator = connectionStatus.querySelector('.status-indicator');
            indicator.className = `status-indicator status-${type}`;
            
            const statusText = {
                connected: 'Conectado',
                disconnected: 'Desconectado', 
                detecting: 'Detectando...'
            };
            
            connectionStatus.innerHTML = `<span class="status-indicator status-${type}"></span>${statusText[type]}`;
        }

        function updateWalletButton(text, enabled) {
            const btn = document.getElementById('walletBtn');
            const btnText = document.getElementById('walletBtnText');
            
            btnText.textContent = text;
            btn.disabled = !enabled;
            
            if (!enabled) {
                btn.className = 'btn btn-outline-secondary';
            } else if (walletState.connected) {
                btn.className = 'btn btn-outline-success';
            } else {
                btn.className = 'btn btn-outline-light';
            }
        }

        function enablePurchasing(enabled) {
            const purchaseBtn = document.getElementById('purchaseBtn');
            purchaseBtn.disabled = !enabled || selectedNumbers.size !== MAX_NUMBERS;
        }

        function toggleDebug() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        // === MANEJO DE NÚMEROS ===
        function createNumberGrid() {
            const grid = document.getElementById('numberGrid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 100; i++) {
                const btn = document.createElement('button');
                btn.className = 'number-btn';
                btn.textContent = i.toString().padStart(2, '0');
                btn.onclick = () => toggleNumber(i);
                grid.appendChild(btn);
            }
        }

        function toggleNumber(number) {
            const btn = document.querySelector(`.number-btn:nth-child(${number})`);
            
            if (selectedNumbers.has(number)) {
                selectedNumbers.delete(number);
                btn.classList.remove('selected');
            } else if (selectedNumbers.size < MAX_NUMBERS) {
                selectedNumbers.add(number);
                btn.classList.add('selected');
            } else {
                alert(`Solo puedes seleccionar ${MAX_NUMBERS} números`);
                return;
            }
            
            updateSelectionDisplay();
        }

        function updateSelectionDisplay() {
            document.getElementById('selectedCount').textContent = selectedNumbers.size;
            enablePurchasing(walletState.connected);
        }

        function quickPick() {
            clearSelection();
            const numbers = [];
            while (numbers.length < MAX_NUMBERS) {
                const num = Math.floor(Math.random() * 100) + 1;
                if (!numbers.includes(num)) {
                    numbers.push(num);
                }
            }
            
            numbers.forEach(num => {
                selectedNumbers.add(num);
                const btn = document.querySelector(`.number-btn:nth-child(${num})`);
                btn.classList.add('selected');
            });
            
            updateSelectionDisplay();
        }

        function clearSelection() {
            selectedNumbers.clear();
            document.querySelectorAll('.number-btn.selected').forEach(btn => {
                btn.classList.remove('selected');
            });
            updateSelectionDisplay();
        }

        async function purchaseTicket() {
            if (selectedNumbers.size !== MAX_NUMBERS) {
                alert(`Debes seleccionar exactamente ${MAX_NUMBERS} números`);
                return;
            }
            
            if (!walletState.connected) {
                alert('Conecta tu wallet primero');
                return;
            }
            
            const numbersArray = Array.from(selectedNumbers).sort((a, b) => a - b);
            
            // Demo purchase
            const result = confirm(`¿Confirmas la compra del boleto NFT?\n\nNúmeros: ${numbersArray.join(', ')}\nPrecio: 0.01 ETH\nRed: Ganache Local`);
            
            if (result) {
                alert(`🎉 ¡Boleto NFT comprado exitosamente!\n\nNúmeros: ${numbersArray.join(', ')}\nTransacción: 0x${Math.random().toString(16).substring(2, 66)}\n\nEn la implementación real se mintearía el NFT y se registraría en blockchain.`);
                clearSelection();
            }
        }

        // === FUNCIONES PRINCIPALES ===
        async function handleWalletAction() {
            if (!walletState.detected) {
                walletManager.showInstallationInstructions();
                return;
            }
            
            if (!walletState.connected) {
                await walletManager.connect();
            } else if (walletState.chainId !== GANACHE_CHAIN_ID) {
                const added = await walletManager.addGanacheNetwork();
                if (!added) {
                    alert('No se pudo agregar la red Ganache. Agrégala manualmente:\n\nRPC URL: http://127.0.0.1:8545\nChain ID: 1337\nSímbolo: ETH');
                }
            } else {
                // Disconnect (not directly possible, show instructions)
                alert('Para desconectar, ve a MetaMask y desconecta manualmente este sitio web.');
            }
        }

        // === INICIALIZACIÓN ===
        let walletManager;

        async function initializeApp() {
            console.log('🚀 Inicializando BingoChain...');
            
            // Create number grid
            createNumberGrid();
            
            // Initialize wallet manager
            walletManager = new WalletManager();
            await walletManager.initialize();
            
            console.log('✅ Aplicación inicializada');
        }

        // Start the app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }
    </script>
</body>
</html>
