<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ Mis Boletos NFT - BingoChain</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; 
            color: white; 
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }
        .back-btn { 
            position: fixed; top: 20px; left: 20px; 
            background: rgba(255,255,255,0.2); color: white; 
            padding: 10px 20px; border-radius: 25px; text-decoration: none; 
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s;
        }
        .back-btn:hover { background: rgba(255,255,255,0.3); transform: translateY(-2px); }
        .card { 
            background: rgba(255,255,255,0.1); 
            backdrop-filter: blur(15px); 
            padding: 25px; 
            border-radius: 20px; 
            margin-bottom: 25px; 
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .btn { 
            background: linear-gradient(45deg, #4CAF50, #45a049); 
            color: white; 
            border: none; 
            padding: 15px 25px; 
            border-radius: 12px; 
            cursor: pointer; 
            font-size: 1em; 
            margin: 8px; 
            transition: all 0.3s;
            font-weight: 600;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .ticket-card {
            background: rgba(255,255,255,0.15);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s;
        }
        .ticket-card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .ticket-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .ticket-id { font-size: 1.2em; font-weight: bold; color: #ffd700; }
        .ticket-status { padding: 5px 12px; border-radius: 20px; font-size: 0.9em; font-weight: bold; }
        .status-winner { background: #4CAF50; color: white; }
        .status-playing { background: #2196F3; color: white; }
        .numbers-display { display: flex; gap: 10px; margin: 15px 0; justify-content: center; }
        .number-ball { 
            width: 40px; height: 40px; 
            border-radius: 50%; 
            background: linear-gradient(45deg, #4CAF50, #45a049); 
            color: white; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: bold; 
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .ticket-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 15px; }
        .info-item { text-align: center; }
        .info-label { font-size: 0.9em; opacity: 0.8; margin-bottom: 5px; }
        .info-value { font-size: 1.1em; font-weight: bold; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }
        .stat-card { text-align: center; background: rgba(0,0,0,0.2); padding: 20px; border-radius: 15px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #ffd700; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: rgba(255, 255, 255, 0.8); }
        .status-message { 
            padding: 15px; 
            border-radius: 10px; 
            margin: 15px 0; 
            text-align: center; 
            font-weight: bold;
            border-left: 4px solid;
        }
        .status-success { background: rgba(76, 175, 80, 0.2); border-color: #4CAF50; }
        .status-error { background: rgba(244, 67, 54, 0.2); border-color: #f44336; }
        .status-warning { background: rgba(255, 152, 0, 0.2); border-color: #FF9800; }
        .status-info { background: rgba(33, 150, 243, 0.2); border-color: #2196F3; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê Volver al Inicio</a>
    
    <div class="container">
        <div class="header">
            <h1>üé´ Mis Boletos NFT</h1>
            <p>Gestiona tus boletos del Sorteo Semanal #1</p>
        </div>

        <!-- Controles -->
        <div class="card">
            <h3>üîó Conexi√≥n</h3>
            <div id="wallet-info">
                <p><strong>Cuenta:</strong> <span id="account-display">No conectada</span></p>
            </div>
            <button class="btn" onclick="connectWallet()">ü¶ä Conectar MetaMask</button>
            <button class="btn" onclick="loadTickets()">üîÑ Recargar Boletos</button>
        </div>

        <!-- Estad√≠sticas -->
        <div class="card">
            <h3>üìä Estad√≠sticas</h3>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number" id="total-tickets">0</div>
                    <div class="stat-label">Boletos Totales</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="winning-tickets">0</div>
                    <div class="stat-label">Boletos Ganadores</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="total-matches">0</div>
                    <div class="stat-label">Aciertos Totales</div>
                </div>
            </div>
        </div>

        <!-- Boletos -->
        <div class="card">
            <h3>üé´ Tus Boletos NFT</h3>
            <div id="tickets-container">
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    <h3>üîó Conecta tu billetera</h3>
                    <p>Conecta MetaMask para ver tus boletos NFT</p>
                </div>
            </div>
        </div>

        <!-- Mensajes -->
        <div id="status-messages"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <script>
        // Configuraci√≥n
        const CONFIG = {
            CONTRACT_ADDRESS: '0x21a59654176f2689d12E828B77a783072CD26680',
            GANACHE_CHAIN_ID: '0x539'
        };

        // ABI actualizado con las funciones correctas del contrato
        const CONTRACT_ABI = [
            {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "address", "name": "_player", "type": "address"}], "name": "getAllPlayerTickets", "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "uint256", "name": "_ticketId", "type": "uint256"}], "name": "getTicket", "outputs": [{"internalType": "uint256", "name": "ticketId", "type": "uint256"}, {"internalType": "uint256", "name": "lotteryId", "type": "uint256"}, {"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "uint8[6]", "name": "chosenNumbers", "type": "uint8[6]"}, {"internalType": "uint256", "name": "matchedNumbers", "type": "uint256"}, {"internalType": "bool", "name": "isWinner", "type": "bool"}, {"internalType": "uint256", "name": "purchaseTime", "type": "uint256"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "tokenURI", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"}
        ];

        // Variables globales
        let web3, contract, userAccount;
        let userTickets = [];

        // Inicializaci√≥n
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (typeof Web3 !== 'undefined') {
                    initializeApp();
                } else {
                    showMessage('‚ùå Error cargando Web3. Recarga la p√°gina.', 'error');
                }
            }, 500);
        });

        function initializeApp() {
            if (typeof window.ethereum !== 'undefined') {
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONFIG.CONTRACT_ADDRESS);
                console.log('‚úÖ Web3 y contrato inicializados');
                
                // Verificar si ya est√° conectado
                checkExistingConnection();
            } else {
                showMessage('‚ùå MetaMask no detectado. Instala MetaMask.', 'error');
            }
        }

        async function checkExistingConnection() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    onAccountConnected(accounts[0]);
                }
            } catch (error) {
                console.log('No hay conexi√≥n previa');
            }
        }

        async function connectWallet() {
            try {
                showMessage('üîó Conectando MetaMask...', 'info');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                onAccountConnected(accounts[0]);
            } catch (error) {
                console.error('Error conectando:', error);
                showMessage('‚ùå Error conectando MetaMask', 'error');
            }
        }

        async function onAccountConnected(account) {
            userAccount = account;
            console.log('üë§ Cuenta conectada:', account);
            
            document.getElementById('account-display').textContent = 
                `${account.substring(0, 6)}...${account.substring(38)}`;
            
            showMessage('‚úÖ MetaMask conectado correctamente', 'success');
            await loadTickets();
        }

        async function loadTickets() {
            if (!userAccount || !contract) {
                showMessage('Por favor conecta tu billetera primero', 'error');
                return;
            }

            try {
                showMessage('üîÑ Cargando tus boletos NFT...', 'info');
                console.log('Cargando tickets para:', userAccount);
                
                // Usar getAllPlayerTickets para obtener los IDs de tickets del jugador
                const ticketIds = await contract.methods.getAllPlayerTickets(userAccount).call();
                console.log('IDs de tickets encontrados:', ticketIds);
                
                if (!ticketIds || ticketIds.length === 0) {
                    displayNoTickets();
                    updateStats(0, 0, 0);
                    showMessage('No tienes boletos NFT a√∫n. ¬°Compra tu primer boleto!', 'warning');
                    return;
                }

                // Obtener detalles de cada ticket usando getTicket
                userTickets = [];
                for (const ticketId of ticketIds) {
                    try {
                        console.log('Obteniendo detalles del ticket:', ticketId);
                        const ticket = await contract.methods.getTicket(ticketId).call();
                        console.log('Detalles del ticket:', ticket);
                        
                        userTickets.push({
                            ticketId: ticket.ticketId,
                            lotteryId: ticket.lotteryId,
                            owner: ticket.owner,
                            numbers: ticket.chosenNumbers.filter(n => n > 0), // Filtrar ceros
                            matches: ticket.matchedNumbers,
                            isWinner: ticket.isWinner,
                            purchaseDate: new Date(parseInt(ticket.purchaseTime) * 1000)
                        });
                    } catch (error) {
                        console.error('Error obteniendo ticket', ticketId, ':', error);
                    }
                }

                console.log('Tickets procesados:', userTickets);

                if (userTickets.length > 0) {
                    displayTickets();
                    const winners = userTickets.filter(t => t.isWinner).length;
                    const totalMatches = userTickets.reduce((sum, t) => sum + parseInt(t.matches), 0);
                    updateStats(userTickets.length, winners, totalMatches);
                    showMessage(`‚úÖ ${userTickets.length} boletos cargados exitosamente`, 'success');
                } else {
                    displayNoTickets();
                    showMessage('No se encontraron boletos v√°lidos', 'warning');
                }

            } catch (error) {
                console.error('Error completo cargando boletos:', error);
                showMessage('‚ùå Error cargando boletos: ' + error.message, 'error');
                displayNoTickets();
            }
        }

        function displayTickets() {
            const container = document.getElementById('tickets-container');
            
            if (userTickets.length === 0) {
                displayNoTickets();
                return;
            }

            let html = '';
            userTickets.forEach((ticket, index) => {
                const statusClass = ticket.isWinner ? 'status-winner' : 'status-playing';
                const statusText = ticket.isWinner ? 'üèÜ GANADOR' : 'üéÆ Jugando';
                
                html += `
                    <div class="ticket-card">
                        <div class="ticket-header">
                            <div class="ticket-id">üé´ Boleto #${ticket.ticketId}</div>
                            <div class="ticket-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="numbers-display">
                            ${ticket.numbers.map(num => `<div class="number-ball">${num}</div>`).join('')}
                        </div>
                        
                        <div class="ticket-info">
                            <div class="info-item">
                                <div class="info-label">Sorteo</div>
                                <div class="info-value">#${ticket.lotteryId}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Aciertos</div>
                                <div class="info-value">${ticket.matches}/6</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Fecha de Compra</div>
                                <div class="info-value">${ticket.purchaseDate.toLocaleDateString()}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Hora</div>
                                <div class="info-value">${ticket.purchaseDate.toLocaleTimeString()}</div>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function displayNoTickets() {
            const container = document.getElementById('tickets-container');
            container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: rgba(255,255,255,0.7);">
                    <h3>üé´ No tienes boletos</h3>
                    <p>Compra boletos en el sorteo para verlos aqu√≠</p>
                    <a href="/demo" style="color: #4CAF50; text-decoration: none; font-size: 1.1em; margin-top: 15px; display: inline-block;">
                        üéÆ Ir a comprar boletos
                    </a>
                </div>
            `;
        }

        function updateStats(total, winners, matches) {
            document.getElementById('total-tickets').textContent = total;
            document.getElementById('winning-tickets').textContent = winners;
            document.getElementById('total-matches').textContent = matches;
        }

        function showMessage(message, type) {
            const container = document.getElementById('status-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                if (messageDiv.parentNode) {
                    messageDiv.parentNode.removeChild(messageDiv);
                }
            }, 5000);
        }

        // Event listeners para cambios de MetaMask
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    location.reload();
                } else {
                    onAccountConnected(accounts[0]);
                }
            });

            window.ethereum.on('chainChanged', () => {
                location.reload();
            });
        }
    </script>
</body>
</html>
