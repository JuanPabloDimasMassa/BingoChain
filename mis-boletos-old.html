<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üé´ BingoChain - Mis Boletos NFT</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh; color: white; padding: 20px;
        }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .back-btn {
            position: absolute; top: 20px; left: 20px;
            background: rgba(255, 255, 255, 0.2); border: none;
            padding: 10px 20px; border-radius: 20px; color: white;
            cursor: pointer; text-decoration: none; transition: all 0.3s;
        }
        .back-btn:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-2px); }
        .wallet-section {
            background: rgba(255, 255, 255, 0.15); padding: 20px;
            border-radius: 15px; margin-bottom: 30px; text-align: center;
            backdrop-filter: blur(10px);
        }
        .connect-btn {
            background: linear-gradient(45deg, #6c5ce7, #5f3dc4); border: none;
            padding: 15px 30px; border-radius: 25px; color: white; font-size: 16px;
            cursor: pointer; transition: all 0.3s; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .connect-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(0,0,0,0.3); }
        .wallet-info {
            background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
            margin-top: 10px; font-family: monospace; font-size: 0.9em;
        }
        .tickets-section {
            background: rgba(255, 255, 255, 0.1); padding: 30px;
            border-radius: 15px; backdrop-filter: blur(10px);
        }
        .tickets-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px; margin-top: 20px;
        }
        .ticket-card {
            background: rgba(255, 255, 255, 0.15); padding: 25px;
            border-radius: 15px; border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s; position: relative;
        }
        .ticket-card:hover { transform: translateY(-5px); border-color: rgba(255, 255, 255, 0.4); }
        .ticket-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 15px; padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        .ticket-id { font-size: 1.2em; font-weight: bold; color: #ffd700; }
        .ticket-status {
            padding: 5px 12px; border-radius: 15px; font-size: 0.8em;
            font-weight: bold; text-transform: uppercase;
        }
        .status-active { background: #2ecc71; color: white; }
        .status-pending { background: #f39c12; color: white; }
        .status-winner { background: #e74c3c; color: white; animation: glow 2s infinite; }
        @keyframes glow { 0%, 100% { box-shadow: 0 0 10px #e74c3c; } 50% { box-shadow: 0 0 20px #e74c3c; } }
        .numbers-display {
            display: flex; flex-wrap: wrap; gap: 8px; margin: 15px 0;
            justify-content: center;
        }
        .number-bubble {
            background: linear-gradient(45deg, #00b894, #00a085);
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 14px; color: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .ticket-info { margin-top: 15px; }
        .info-row {
            display: flex; justify-content: space-between; margin: 8px 0;
            font-size: 0.9em;
        }
        .info-label { color: rgba(255, 255, 255, 0.8); }
        .info-value { font-weight: bold; }
        .no-tickets {
            text-align: center; padding: 60px 20px;
            background: rgba(255, 255, 255, 0.1); border-radius: 15px;
        }
        .no-tickets h3 { font-size: 1.5em; margin-bottom: 15px; color: rgba(255, 255, 255, 0.8); }
        .buy-ticket-btn {
            background: linear-gradient(45deg, #ff6b6b, #ee5a24); border: none;
            padding: 12px 25px; border-radius: 20px; color: white;
            cursor: pointer; transition: all 0.3s; margin-top: 15px;
            text-decoration: none; display: inline-block;
        }
        .buy-ticket-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .refresh-btn {
            background: rgba(255, 255, 255, 0.2); border: none;
            padding: 10px 20px; border-radius: 20px; color: white;
            cursor: pointer; transition: all 0.3s; float: right;
        }
        .refresh-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .loading {
            display: inline-block; width: 20px; height: 20px;
            border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
            border-top-color: #fff; animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .status-message {
            background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px;
            margin: 20px 0; text-align: center; font-weight: bold;
        }
        .success { background: rgba(46, 204, 113, 0.3) !important; }
        .error { background: rgba(231, 76, 60, 0.3) !important; }
        .warning { background: rgba(241, 196, 15, 0.3) !important; }
        .hidden { display: none; }
        .stats-section {
            background: rgba(255, 255, 255, 0.1); padding: 20px;
            border-radius: 15px; margin-bottom: 20px;
        }
        .stats-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px; margin-top: 15px;
        }
        .stat-item {
            background: rgba(0, 0, 0, 0.2); padding: 15px;
            border-radius: 10px; text-align: center;
        }
        .stat-number { font-size: 2em; font-weight: bold; color: #ffd700; margin-bottom: 5px; }
        .stat-label { font-size: 0.9em; color: rgba(255, 255, 255, 0.8); }
    </style>
</head>
<body>
    <a href="/" class="back-btn">‚Üê Volver al Inicio</a>
    
    <div class="container">
        <div class="header">
            <h1>üé´ Mis Boletos NFT</h1>
            <p>Gestiona tus boletos del Sorteo Semanal #1</p>
        </div>

        <!-- Estado de MetaMask -->
        <div class="wallet-section">
            <div id="wallet-disconnected">
                <h3>ÔøΩÔøΩ Conectar MetaMask</h3>
                <p>Conecta tu billetera para ver tus boletos NFT</p>
                <button class="connect-btn" onclick="connectWallet()">Conectar MetaMask</button>
            </div>
            
            <div id="wallet-connected" class="hidden">
                <h3>‚úÖ Billetera Conectada</h3>
                <div id="wallet-info" class="wallet-info"></div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-section" id="stats-section" style="display: none;">
            <h3>ÔøΩÔøΩ Mis Estad√≠sticas</h3>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="total-tickets">0</div>
                    <div class="stat-label">Total Boletos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="active-tickets">0</div>
                    <div class="stat-label">Activos</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="winner-tickets">0</div>
                    <div class="stat-label">Ganadores</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="total-invested">0 ETH</div>
                    <div class="stat-label">Invertido</div>
                </div>
            </div>
        </div>

        <!-- Secci√≥n de Boletos -->
        <div class="tickets-section" id="tickets-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>üéØ Mis Boletos del Sorteo</h3>
                <button class="refresh-btn" onclick="loadTickets()">üîÑ Actualizar</button>
            </div>
            
            <div id="tickets-container">
                <!-- Los boletos se cargar√°n aqu√≠ -->
            </div>
        </div>

        <!-- Mensajes de Estado -->
        <div id="status-message" class="status-message hidden"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
    <script>
        const CONTRACT_ADDRESS = '0x21a59654176f2689d12E828B77a783072CD26680';
        const GANACHE_CHAIN_ID = '0x539';
        const CONTRACT_ABI = [
            {"inputs": [{"internalType": "address", "name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"internalType": "uint256", "name": "", "type": "uint256"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "address", "name": "_player", "type": "address"}], "name": "getAllPlayerTickets", "outputs": [{"internalType": "uint256[]", "name": "", "type": "uint256[]"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "uint256", "name": "_ticketId", "type": "uint256"}], "name": "getTicket", "outputs": [{"internalType": "uint256", "name": "ticketId", "type": "uint256"}, {"internalType": "uint256", "name": "lotteryId", "type": "uint256"}, {"internalType": "address", "name": "owner", "type": "address"}, {"internalType": "uint8[6]", "name": "chosenNumbers", "type": "uint8[6]"}, {"internalType": "uint256", "name": "matchedNumbers", "type": "uint256"}, {"internalType": "bool", "name": "isWinner", "type": "bool"}, {"internalType": "uint256", "name": "purchaseTime", "type": "uint256"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "tokenURI", "outputs": [{"internalType": "string", "name": "", "type": "string"}], "stateMutability": "view", "type": "function"},
            {"inputs": [{"internalType": "uint256", "name": "tokenId", "type": "uint256"}], "name": "ownerOf", "outputs": [{"internalType": "address", "name": "", "type": "address"}], "stateMutability": "view", "type": "function"}
        ];

        let web3, contract, userAccount;
        let userTickets = [];

        window.addEventListener('load', async () => {
            await checkWalletConnection();
        });

        async function checkWalletConnection() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) await connectWallet();
                } catch (error) {
                    console.error('Error verificando conexi√≥n:', error);
                }
            }
        }

        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showMessage('MetaMask no est√° instalado. Por favor instala MetaMask.', 'error');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                web3 = new Web3(window.ethereum);
                contract = new web3.eth.Contract(CONTRACT_ABI, CONTRACT_ADDRESS);

                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== GANACHE_CHAIN_ID) {
                    showMessage('‚ö†Ô∏è Por favor cambia a la red Ganache (Chain ID: 1337)', 'warning');
                }

                document.getElementById('wallet-disconnected').classList.add('hidden');
                document.getElementById('wallet-connected').classList.remove('hidden');
                document.getElementById('wallet-info').innerHTML = 
                    `Cuenta: ${userAccount.substring(0,10)}...${userAccount.substring(userAccount.length-8)}`;
                
                document.getElementById('stats-section').style.display = 'block';
                document.getElementById('tickets-section').style.display = 'block';

                showMessage('‚úÖ MetaMask conectado correctamente', 'success');
                await loadTickets();

            } catch (error) {
                console.error('Error conectando:', error);
                showMessage('Error conectando MetaMask: ' + error.message, 'error');
            }
        }

        async function loadTickets() {
            if (!userAccount || !contract) {
                showMessage('Por favor conecta tu billetera primero', 'error');
                return;
            }

            try {
                showMessage('üîÑ Cargando tus boletos NFT...', 'warning');
                
                // Obtener balance de NFTs del usuario
                const balance = await contract.methods.balanceOf(userAccount).call();
                console.log('Balance de NFTs:', balance);

                if (balance == 0) {
                    displayNoTickets();
                    updateStats(0, 0, 0);
                    showMessage('No tienes boletos NFT a√∫n. ¬°Compra tu primer boleto!', 'warning');
                    return;
                }

                // Obtener todos los token IDs del usuario
                const tokenIds = [];
                for (let i = 0; i < balance; i++) {
                    const tokenId = await contract.methods.tokenOfOwnerByIndex(userAccount, i).call();
                    tokenIds.push(tokenId);
                }

                // Obtener detalles de cada boleto
                userTickets = [];
                for (const tokenId of tokenIds) {
                    try {
                        const ticket = await contract.methods.getTicketByTokenId(tokenId).call();
                        userTickets.push({
                            tokenId: tokenId,
                            id: ticket.id,
                            numbers: ticket.numbers.filter(n => n > 0), // Filtrar ceros
                            matches: ticket.matches,
                            isWinner: ticket.isWinner,
                            purchaseDate: new Date(ticket.purchaseDate * 1000)
                        });
                    } catch (error) {
                        console.error(`Error obteniendo boleto ${tokenId}:`, error);
                    }
                }

                displayTickets();
                updateStats(userTickets.length, userTickets.filter(t => !t.isWinner).length, userTickets.filter(t => t.isWinner).length);
                showMessage(`‚úÖ Se cargaron ${userTickets.length} boletos correctamente`, 'success');

            } catch (error) {
                console.error('Error cargando boletos:', error);
                showMessage('Error cargando boletos: ' + (error.message || 'Error desconocido'), 'error');
            }
        }

        function displayTickets() {
            const container = document.getElementById('tickets-container');
            
            if (userTickets.length === 0) {
                displayNoTickets();
                return;
            }

            container.innerHTML = '<div class="tickets-grid"></div>';
            const grid = container.querySelector('.tickets-grid');

            userTickets.forEach(ticket => {
                const ticketCard = document.createElement('div');
                ticketCard.className = 'ticket-card';
                
                const statusClass = ticket.isWinner ? 'status-winner' : 'status-active';
                const statusText = ticket.isWinner ? 'GANADOR!' : 'ACTIVO';
                
                ticketCard.innerHTML = `
                    <div class="ticket-header">
                        <div class="ticket-id">üé´ NFT #${ticket.tokenId}</div>
                        <div class="ticket-status ${statusClass}">${statusText}</div>
                    </div>
                    
                    <div class="numbers-display">
                        ${ticket.numbers.map(num => `<div class="number-bubble">${num}</div>`).join('')}
                    </div>
                    
                    <div class="ticket-info">
                        <div class="info-row">
                            <span class="info-label">üéØ Aciertos:</span>
                            <span class="info-value">${ticket.matches}/6</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üìÖ Comprado:</span>
                            <span class="info-value">${ticket.purchaseDate.toLocaleDateString()}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üé≤ Sorteo:</span>
                            <span class="info-value">#1</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">üí∞ Precio:</span>
                            <span class="info-value">GRATIS</span>
                        </div>
                    </div>
                `;
                
                grid.appendChild(ticketCard);
            });
        }

        function displayNoTickets() {
            const container = document.getElementById('tickets-container');
            container.innerHTML = `
                <div class="no-tickets">
                    <h3>üé´ No tienes boletos a√∫n</h3>
                    <p>¬°Compra tu primer boleto NFT y participa en el sorteo!</p>
                    <a href="http://localhost:8080/BingoChain/demo.html" class="buy-ticket-btn">
                        üéÆ Comprar Primer Boleto
                    </a>
                </div>
            `;
        }

        function updateStats(total, active, winners) {
            document.getElementById('total-tickets').textContent = total;
            document.getElementById('active-tickets').textContent = active;
            document.getElementById('winner-tickets').textContent = winners;
            document.getElementById('total-invested').textContent = '0 ETH'; // Gratis durante testing
        }

        function showMessage(message, type = 'info') {
            const messageDiv = document.getElementById('status-message');
            messageDiv.textContent = message;
            messageDiv.className = `status-message ${type}`;
            messageDiv.classList.remove('hidden');
            setTimeout(() => messageDiv.classList.add('hidden'), 5000);
        }

        // Listeners para cambios en MetaMask
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) location.reload();
                else {
                    userAccount = accounts[0];
                    document.getElementById('wallet-info').innerHTML = 
                        `Cuenta: ${userAccount.substring(0,10)}...${userAccount.substring(userAccount.length-8)}`;
                    loadTickets(); // Recargar boletos para la nueva cuenta
                }
            });
            window.ethereum.on('chainChanged', () => location.reload());
        }
    </script>
</body>
</html>
